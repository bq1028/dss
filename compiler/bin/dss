#!/usr/bin/env node

const fs = require('fs')
const path = require('path')
const glob = require('glob')
const dss = require('..')

const read = filePath => fs.readFileSync(filePath, 'utf-8')

const [globPattern, dist, bundleFilename] = process.argv.slice(2)

const jsSheets = glob.sync(globPattern)

const compilePromises = jsSheets.map(filePath => {
  const css = read(filePath)
  return dss.singleton(css, { filePath, readableClass: process.env.NODE_ENV !== 'production' })
})

Promise.all(compilePromises).then(results => {
  let flush
  results.forEach(({locals, _flush}, i) => {
    fs.writeFileSync(
      path.resolve(path.join(dist, path.basename(jsSheets[i])+'.json')),
      JSON.stringify(locals, null, 2)
    )
    flush = _flush
  })

  fs.writeFileSync(path.resolve(path.join(dist, bundleFilename || 'index.css')), flush())
}).catch(e => {
  console.error(e)
  process.exit(1)
})
